-- Delta Executor Compatible Midnight Chasers Farm Script
-- Combines original functionality with a custom Zuan WM Dock-like UI

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local VirtualUser = game:GetService("VirtualUser")

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

-- Anti-AFK System
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- Stream Around Models
task.spawn(function()
    for _, v in pairs(workspace:GetDescendants()) do
        if v:IsA("Model") then
            task.spawn(function()
                LocalPlayer:RequestStreamAroundAsync(v.WorldPivot.Position, 3)
            end)
            task.wait(0.1) -- Prevent spam
        end
    end
end)

-- Core Functions
local function reachedMax(value)
    local seatCount = 0
    for _, v in pairs(value:GetDescendants()) do
        if v:IsA("Seat") then
            seatCount = seatCount + 1
        end
    end
    local maxGifts = seatCount * 5
    local giftsFolder = value:FindFirstChild("Gifts")
    return giftsFolder and #giftsFolder:GetChildren() == maxGifts
end

local function hideWorkspaceObjects(plr)
    if not ReplicatedStorage:FindFirstChild("mrbackupfolder") then
        local folder = Instance.new("Folder", ReplicatedStorage)
        folder.Name = "mrbackupfolder"
    end
    
    local playerName = plr.Name
    local playerDisplayName = plr.DisplayName
    
    for _, v in pairs(workspace:GetChildren()) do
        local shouldHide = false
        if v.ClassName == "Model" or v.ClassName == "Folder" then
            if v.Name ~= "" and not string.find(v.Name, playerName) and not string.find(v.Name, playerDisplayName) and not string.find(v.Name, "Gift") then
                shouldHide = true
            end
        elseif v:IsA("MeshPart") then
            shouldHide = true
        end
        
        if shouldHide then
            v.Parent = ReplicatedStorage:FindFirstChild("mrbackupfolder")
        end
    end
end

local function restoreWorkspaceObjects()
    local backupFolder = ReplicatedStorage:FindFirstChild("mrbackupfolder")
    if backupFolder then
        for _, v in pairs(backupFolder:GetChildren()) do
            v.Parent = workspace
            task.wait(0.01) -- Prevent spam
        end
    end
end

local function ensureGroundPart()
    if not _G.ooga then
        local new = Instance.new("Part", workspace)
        new.Anchored = true
        new.CanCollide = false
        new.Size = Vector3.new(10000, 10, 10000)
        new.Transparency = 1
        new.Name = "GroundAlignPart"
        _G.ooga = new
    end
end

local function tweenToPosition(car, targetPos, speed)
    if not car or not car.PrimaryPart then return end
    
    local dist = (car.PrimaryPart.Position - targetPos.Position).Magnitude
    local tweenInfo = TweenInfo.new(dist / speed, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut, 0, false, 0)
    local tweenValue = Instance.new("CFrameValue")
    tweenValue.Value = car:GetPrimaryPartCFrame()
    
    local connection
    connection = tweenValue.Changed:Connect(function()
        if not car or not car.PrimaryPart then 
            connection:Disconnect()
            return 
        end
        
        local newPos = tweenValue.Value.Position
        _G.ooga.Position = newPos - Vector3.new(0, 14, 0)
        car:PivotTo(CFrame.new(_G.ooga.Position + Vector3.new(0, 7, 0), targetPos.Position))
        local velo = car.PrimaryPart.CFrame.LookVector * speed
        car.PrimaryPart.AssemblyLinearVelocity = velo
    end)
    
    local tween = TweenService:Create(tweenValue, tweenInfo, { Value = targetPos })
    tween:Play()
    
    repeat
        task.wait(0)
    until tween.PlaybackState ~= Enum.PlaybackState.Playing
end

local function tweenToLocation(car, locations, plr)
    if not car or not car.PrimaryPart then return end
    
    repeat
        task.wait(0.1)
        local speed = getfenv().speed or 230
        if getfenv().cancelman then
            speed = 50
        end
        
        local pos = locations.WorldPivot + Vector3.new(0, 5, 0)
        local dist = (plr.Character.HumanoidRootPart.Position - pos.Position).Magnitude
        local tweenInfo = TweenInfo.new(dist / speed, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut, 0, false, 0)
        local tweenValue = Instance.new("CFrameValue")
        tweenValue.Value = car:GetPrimaryPartCFrame()
        
        local connection
        connection = tweenValue.Changed:Connect(function()
            if not car or not car.PrimaryPart then 
                connection:Disconnect()
                return 
            end
            
            local test = tweenValue.Value.Position
            local playerDist = plr:DistanceFromCharacter(pos.Position)
            
            if playerDist > 100 then
                _G.ooga.Position = test - Vector3.new(0, 14, 0)
                car:PivotTo(CFrame.new(_G.ooga.Position + Vector3.new(0, 7, 0), pos.Position))
                local velo = car.PrimaryPart.CFrame.LookVector * speed
                car.PrimaryPart.AssemblyLinearVelocity = velo
            elseif playerDist < 100 and playerDist > 10 then
                if not getfenv().cancelman then
                    getfenv().cancelman = true
                    if getfenv().tween then
                        getfenv().tween:Cancel()
                    end
                end
                local velo = car.PrimaryPart.CFrame.LookVector * 20
                _G.ooga.Position = test - Vector3.new(0, 8, 0)
                car:PivotTo(CFrame.new(_G.ooga.Position + Vector3.new(0, 7, 0), Vector3.new(pos.X, car.PrimaryPart.CFrame.Y, pos.Z)))
                car.PrimaryPart.AssemblyLinearVelocity = velo
            elseif playerDist < 5 then
                local lookat = car.PrimaryPart.CFrame * CFrame.new(0, 0, -10000)
                car:PivotTo(CFrame.new(Vector3.new(pos.X, _G.ooga.CFrame.Y + 7, pos.Z), lookat.Position))
                car.PrimaryPart.AssemblyLinearVelocity = Vector3.zero
            end
        end)
        
        getfenv().tween = TweenService:Create(tweenValue, tweenInfo, { Value = pos })
        getfenv().tween:Play()
        
        repeat
            task.wait(0)
        until getfenv().tween.PlaybackState ~= Enum.PlaybackState.Playing
    until not locations:FindFirstChild("Highlight") or not _G.test
    getfenv().cancelman = nil
end

-- UI Library (Custom Zuan WM Dock-like UI)
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "FarmMenu"
ScreenGui.Parent = game.CoreGui

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 250, 0, 30)
MainFrame.Position = UDim2.new(0, 10, 0, 10)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

-- Title Bar
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 30)
TitleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Name = "TitleLabel"
TitleLabel.Size = UDim2.new(1, -60, 1, 0)
TitleLabel.Position = UDim2.new(0, 0, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "Midnight Chasers Farm"
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.TextSize = 14
TitleLabel.Font = Enum.Font.SourceSans
TitleLabel.Parent = TitleBar

-- Close Button
local CloseButton = Instance.new("TextButton")
CloseButton.Name = "CloseButton"
CloseButton.Size = UDim2.new(0, 30, 1, 0)
CloseButton.Position = UDim2.new(1, -30, 0, 0)
CloseButton.BackgroundTransparency = 1
CloseButton.Text = "X"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.TextSize = 14
CloseButton.Font = Enum.Font.SourceSans
CloseButton.Parent = TitleBar

-- Minimize Button
local MinimizeButton = Instance.new("TextButton")
MinimizeButton.Name = "MinimizeButton"
MinimizeButton.Size = UDim2.new(0, 30, 1, 0)
MinimizeButton.Position = UDim2.new(1, -60, 0, 0)
MinimizeButton.BackgroundTransparency = 1
MinimizeButton.Text = "-"
MinimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MinimizeButton.TextSize = 14
MinimizeButton.Font = Enum.Font.SourceSans
MinimizeButton.Parent = TitleBar

-- Content Frame
local ContentFrame = Instance.new("Frame")
ContentFrame.Name = "ContentFrame"
ContentFrame.Size = UDim2.new(1, 0, 1, -30)
ContentFrame.Position = UDim2.new(0, 0, 0, 30)
ContentFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
ContentFrame.BorderSizePixel = 0
ContentFrame.Visible = true
ContentFrame.Parent = MainFrame

local Layout = Instance.new("UIListLayout")
Layout.Name = "Layout"
Layout.Padding = UDim.new(0, 5)
Layout.Parent = ContentFrame

local Padding = Instance.new("UIPadding")
Padding.Name = "Padding"
Padding.PaddingLeft = UDim.new(0, 10)
Padding.PaddingTop = UDim.new(0, 5)
Padding.Parent = ContentFrame

-- UI Elements
local AutoFarmToggle = Instance.new("TextButton")
AutoFarmToggle.Name = "AutoFarmToggle"
AutoFarmToggle.Size = UDim2.new(1, -20, 0, 30)
AutoFarmToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
AutoFarmToggle.BorderSizePixel = 0
AutoFarmToggle.Text = "Auto Farm: OFF"
AutoFarmToggle.TextColor3 = Color3.fromRGB(255, 100, 100)
AutoFarmToggle.TextSize = 14
AutoFarmToggle.Font = Enum.Font.SourceSans
AutoFarmToggle.Parent = ContentFrame

local AutoDeliverToggle = Instance.new("TextButton")
AutoDeliverToggle.Name = "AutoDeliverToggle"
AutoDeliverToggle.Size = UDim2.new(1, -20, 0, 30)
AutoDeliverToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
AutoDeliverToggle.BorderSizePixel = 0
AutoDeliverToggle.Text = "Auto Deliver: OFF"
AutoDeliverToggle.TextColor3 = Color3.fromRGB(255, 100, 100)
AutoDeliverToggle.TextSize = 14
AutoDeliverToggle.Font = Enum.Font.SourceSans
AutoDeliverToggle.Parent = ContentFrame

local SpeedBox = Instance.new("TextBox")
SpeedBox.Name = "SpeedBox"
SpeedBox.Size = UDim2.new(1, -20, 0, 30)
SpeedBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
SpeedBox.BorderSizePixel = 0
SpeedBox.Text = "Speed: 300"
SpeedBox.TextColor3 = Color3.fromRGB(255, 255, 255)
SpeedBox.TextSize = 14
SpeedBox.Font = Enum.Font.SourceSans
SpeedBox.ClearTextOnFocus = false
SpeedBox.Parent = ContentFrame

-- Dragging Functionality
local dragging = false
local dragStart = nil
local startPos = nil

local function updatePosition(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

TitleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        updatePosition(input)
    end
end)

-- Button Functionality
local autoFarmActive = false
local autoDeliverActive = false

AutoFarmToggle.MouseButton1Click:Connect(function()
    autoFarmActive = not autoFarmActive
    AutoFarmToggle.Text = "Auto Farm: " .. (autoFarmActive and "ON" or "OFF")
    AutoFarmToggle.TextColor3 = autoFarmActive and Color3.fromRGB(100, 255, 100) or Color3.fromRGB(255, 100, 100)
    
    if autoFarmActive then
        hideWorkspaceObjects(LocalPlayer)
        _G.auto = true
        -- Start Auto Farm Logic in a separate task
        task.spawn(function()
            while _G.auto do
                task.wait(0.1)
                local plr = Players.LocalPlayer
                local chr = plr.Character
                if not chr or not chr:FindFirstChild("Humanoid") or chr.Humanoid.Health <= 0 then
                    _G.auto = false
                    AutoFarmToggle.Text = "Auto Farm: OFF"
                    AutoFarmToggle.TextColor3 = Color3.fromRGB(255, 100, 100)
                    break
                end
                
                local hum = chr.Humanoid
                local car = hum.SeatPart
                if car then
                    car = car.Parent
                    ensureGroundPart()
                    local weightPart = car.Body:FindFirstChild("#Weight")
                    if weightPart then
                        car.PrimaryPart = weightPart
                    end

                    local frames = {
                        CFrame.new(105.419128, -26.0098934, 7965.37988, -3.36170197e-05, 0.951051414, -0.309032798, -1, -3.36170197e-05, 5.31971455e-06, -5.31971455e-06, 0.309032798, 0.951051414),
                        CFrame.new(2751.86499, -26.0098934, 3694.63354, 3.34978104e-05, 0.951051414, -0.309032798, -1, 3.34978104e-05, -5.31971455e-06, 5.31971455e-06, 0.309032798, 0.951051414),
                        CFrame.new(-8821.48438, -26.0098934, 2042.49939, -3.36170197e-05, 0.951051414, -0.309032798, -1, -3.36170197e-05, 5.31971455e-06, -5.31971455e-06, 0.309032798, 0.951051414),
                        CFrame.new(-6408.62109, -26.0098934, -727.765198, 3.34978104e-05, 0.951051414, -0.309032798, -1, 3.34978104e-05, -5.31971455e-06, 5.31971455e-06, 0.309032798, 0.951051414),
                        CFrame.new(-6099.79639, -26.00989345, -1027.94556, -3.36170197e-05, 0.951051414, -0.309032798, -1, -3.36170197e-05, 5.31971455e-06, -5.31971455e-06, 0.309032798, 0.951051414),
                        CFrame.new(-6066.70068, -26.0098934, 493.255524, 3.34978104e-05, 0.951051414, -0.309032798, -1, 3.34978104e-05, -5.31971455e-06, 5.31971455e-06, 0.309032798, 0.951051414),
                        CFrame.new(132.786133, -26.0098934, 15.2286377, 3.34978104e-05, 0.951051414, -0.309032798, -1, 3.34978104e-05, -5.31971455e-06, 5.31971455e-06, 0.309032798, 0.951051414),
                        CFrame.new(-7692.85449, -26.0098934, -4668.61963, -3.36170197e-05, 0.951051414, -0.309032798, -1, -3.36170197e-05, 5.31971455e-06, -5.31971455e-06, 0.309032798, 0.951051414),
                        CFrame.new(4887.24609, -26.0098934, 1222.96826, -3.36170197e-05, 0.951051414, -0.309032798, -1, -3.36170197e-05, 5.31971455e-06, -5.31971455e-06, 0.309032798, 0.951051414)
                    }

                    for _, frame in pairs(frames) do
                        if not _G.auto then break end
                        local speed = getfenv().speed or 300
                        local pos = frame + Vector3.new(0, 5, 0)
                        tweenToPosition(car, pos, speed)
                    end
                end
            end
        end)
    else
        _G.auto = false
        if getfenv().tween then
            getfenv().tween:Cancel()
        end
        restoreWorkspaceObjects()
    end
end)

AutoDeliverToggle.MouseButton1Click:Connect(function()
    autoDeliverActive = not autoDeliverActive
    AutoDeliverToggle.Text = "Auto Deliver: " .. (autoDeliverActive and "ON" or "OFF")
    AutoDeliverToggle.TextColor3 = autoDeliverActive and Color3.fromRGB(100, 255, 100) or Color3.fromRGB(255, 100, 100)
    
    if autoDeliverActive then
        hideWorkspaceObjects(LocalPlayer)
        _G.test = true
        -- Start Auto Deliver Logic in a separate task
        task.spawn(function()
            while _G.test do
                task.wait(0.1)
                local plr = Players.LocalPlayer
                local chr = plr.Character
                if not chr or not chr:FindFirstChild("Humanoid") or chr.Humanoid.Health <= 0 then
                    _G.test = false
                    AutoDeliverToggle.Text = "Auto Deliver: OFF"
                    AutoDeliverToggle.TextColor3 = Color3.fromRGB(255, 100, 100)
                    break
                end
                
                ensureGroundPart()
                local seat = chr.Humanoid.SeatPart
                if seat then
                    local car = seat.Parent
                    local weightPart = car.Body:FindFirstChild("#Weight")
                    if weightPart then
                        car.PrimaryPart = weightPart
                    end

                    local locations
                    local maxdistance = math.huge
                    for _, v in pairs(workspace:GetChildren()) do
                        if v.Name == "" and v:FindFirstChild("Highlight") then
                            local dist = (chr.PrimaryPart.Position - v.WorldPivot.Position).Magnitude
                            if dist < maxdistance then
                                maxdistance = dist
                                locations = v
                            end
                        end
                    end

                    if locations then
                        tweenToLocation(car, locations, plr)
                    elseif not locations and workspace:FindFirstChild("GiftPickup") then
                        repeat
                            task.wait(0.1)
                            if car and car.PrimaryPart then
                                car.PrimaryPart.AssemblyLinearVelocity = Vector3.zero
                                car:PivotTo(CFrame.new(workspace.GiftPickup.WorldPivot.Position + Vector3.new(0, 5, 0)))
                            end
                        until reachedMax(car) or not _G.test
                    end
                end
            end
        end)
    else
        _G.test = false
        if getfenv().tween then
            getfenv().tween:Cancel()
        end
        restoreWorkspaceObjects()
    end
end)

SpeedBox.FocusLost:Connect(function(enter)
    local speed = tonumber(SpeedBox.Text:gsub("Speed: ", ""))
    if speed then
        getfenv().speed = speed
        SpeedBox.Text = "Speed: " .. speed
    else
        SpeedBox.Text = "Speed: " .. (getfenv().speed or 300)
    end
end)

CloseButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

MinimizeButton.MouseButton1Click:Connect(function()
    ContentFrame.Visible = not ContentFrame.Visible
    MinimizeButton.Text = ContentFrame.Visible and "-" or "+"
end)

-- Initialize ground part
ensureGroundPart()
