-- // Midnight Chasers: Zuan WM Dock Final Fix Total üßô‚Äç‚ôÇÔ∏è //
-- Flat Dark Panel Mode | Fully Working GUI + Logic | Optimized for Delta Mobile

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- State
getgenv().AutoFarm = false
getgenv().AutoDeliver = false
getgenv().Speed = 250
getgenv().IsRunning = false
getgenv().Minimized = false
getgenv().Closed = false

-- Anti AFK
LocalPlayer.Idled:Connect(function()
    local vu = game:GetService("VirtualUser")
    vu:CaptureController()
    vu:ClickButton2(Vector2.new())
end)

-- Utility functions
local function ensureGround()
    if not getgenv().GroundPart then
        local part = Instance.new("Part", workspace)
        part.Anchored = true
        part.Size = Vector3.new(10000, 10, 10000)
        part.Position = Vector3.new(0, -50, 0)
        part.Color = Color3.fromRGB(25, 25, 25)
        getgenv().GroundPart = part
    end
end

local function findCar()
    local chr = LocalPlayer.Character
    if not chr then return nil end
    local hum = chr:FindFirstChildOfClass("Humanoid")
    if hum and hum.SeatPart and hum.SeatPart.Parent then
        local car = hum.SeatPart.Parent
        if car:FindFirstChild("Body") and car.Body:FindFirstChild("#Weight") then
            car.PrimaryPart = car.Body["#Weight"]
            return car
        end
    end
    return nil
end

local function alignCarToGround(car)
    if not car or not car.PrimaryPart then return end
    local ray = Ray.new(car.PrimaryPart.Position, Vector3.new(0, -100, 0))
    local hit, pos = Workspace:FindPartOnRay(ray, car)
    if hit then
        local offset = 3
        car:PivotTo(CFrame.new(Vector3.new(pos.X, pos.Y + offset, pos.Z), car.PrimaryPart.CFrame.LookVector))
    end
end

local function tpBelowSurface(car)
    if car and car.PrimaryPart then
        car:PivotTo(car.PrimaryPart.CFrame - Vector3.new(0, 8, 0))
    end
end

local function tpAboveSurface(car)
    if car and car.PrimaryPart then
        alignCarToGround(car)
    end
end

local function smoothTween(car, targetPos, speed)
    if not car or not car.PrimaryPart then return end
    ensureGround()
    local startPos = car.PrimaryPart.Position
    local dist = (startPos - targetPos.Position).Magnitude
    local dur = dist / speed
    local start = tick()
    while tick() - start < dur and getgenv().IsRunning do
        local dt = RunService.Heartbeat:Wait()
        local alpha = math.clamp((tick() - start) / dur, 0, 1)
        local eased = 0.5 - 0.5 * math.cos(math.pi * alpha)
        local newPos = startPos:Lerp(targetPos.Position, eased)
        car:PivotTo(CFrame.new(newPos + Vector3.new(0, 7, 0), targetPos.Position))
        car.PrimaryPart.AssemblyLinearVelocity = car.PrimaryPart.CFrame.LookVector * speed
    end
    alignCarToGround(car)
end

local function autoFarmLoop()
    task.spawn(function()
        getgenv().IsRunning = true
        ensureGround()
        local car = findCar()
        if not car then return end
        local frames = {
            CFrame.new(100, -25, 7960),
            CFrame.new(2750, -25, 3690),
            CFrame.new(-8800, -25, 2050),
            CFrame.new(-6400, -25, -720),
            CFrame.new(4900, -25, 1200)
        }
        while getgenv().AutoFarm and getgenv().IsRunning do
            for _, pos in ipairs(frames) do
                if not getgenv().AutoFarm then break end
                smoothTween(car, pos + Vector3.new(0, 5, 0), getgenv().Speed)
                task.wait(0.2)
            end
        end
        getgenv().IsRunning = false
    end)
end

local function autoDeliverLoop()
    task.spawn(function()
        getgenv().IsRunning = true
        ensureGround()
        while getgenv().AutoDeliver and getgenv().IsRunning do
            local car = findCar()
            local plr = LocalPlayer
            if not car or not plr.Character then task.wait(1) continue end
            local nearest, dist = nil, math.huge
            for _, v in pairs(workspace:GetChildren()) do
                if v:FindFirstChild("Highlight") then
                    local d = (plr.Character.HumanoidRootPart.Position - v.WorldPivot.Position).Magnitude
                    if d < dist then
                        dist = d
                        nearest = v
                    end
                end
            end
            if nearest then
                tpBelowSurface(car)
                smoothTween(car, nearest.WorldPivot + Vector3.new(0, 5, 0), getgenv().Speed)
                tpAboveSurface(car)
            else
                task.wait(1)
            end
        end
        getgenv().IsRunning = false
    end)
end

-- GUI CREATION --
local pg = LocalPlayer:FindFirstChildOfClass("PlayerGui") or game:GetService("CoreGui")
local gui = Instance.new("ScreenGui", pg)
gui.Name = "ZuanDock"
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

gui.ResetOnSpawn = false
local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 300, 0, 250)
frame.Position = UDim2.new(1, -320, 1, -280)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
frame.BorderSizePixel = 0
frame.Active = true
local corner = Instance.new("UICorner", frame)
corner.CornerRadius = UDim.new(0, 10)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, -60, 0, 35)
title.Position = UDim2.new(0, 10, 0, 0)
title.BackgroundTransparency = 1
title.Text = "Zuan Dock"
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextScaled = true

local minBtn = Instance.new("TextButton", frame)
minBtn.Size = UDim2.new(0, 25, 0, 25)
minBtn.Position = UDim2.new(1, -55, 0, 5)
minBtn.Text = "‚Äì"
minBtn.Font = Enum.Font.GothamBold
minBtn.TextSize = 20
minBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
minBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
local mc = Instance.new("UICorner", minBtn)

local closeBtn = Instance.new("TextButton", frame)
closeBtn.Size = UDim2.new(0, 25, 0, 25)
closeBtn.Position = UDim2.new(1, -30, 0, 5)
closeBtn.Text = "X"
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 18
closeBtn.TextColor3 = Color3.fromRGB(255, 120, 120)
closeBtn.BackgroundColor3 = Color3.fromRGB(80, 40, 40)
local cc = Instance.new("UICorner", closeBtn)

local content = Instance.new("ScrollingFrame", frame)
content.Size = UDim2.new(1, -10, 1, -45)
content.Position = UDim2.new(0, 5, 0, 40)
content.BackgroundTransparency = 1
content.ScrollBarThickness = 4
local layout = Instance.new("UIListLayout", content)
layout.Padding = UDim.new(0, 6)
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center

local status = Instance.new("TextLabel", frame)
status.Size = UDim2.new(1, 0, 0, 20)
status.Position = UDim2.new(0, 0, 1, -20)
status.BackgroundTransparency = 1
status.Font = Enum.Font.Gotham
status.TextSize = 14
status.TextColor3 = Color3.fromRGB(255, 100, 100)
status.Text = "üî¥ Idle"

local function createButton(text, callback)
    local b = Instance.new("TextButton", content)
    b.Size = UDim2.new(1, -20, 0, 35)
    b.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    b.TextColor3 = Color3.new(1,1,1)
    b.Font = Enum.Font.Gotham
    b.TextSize = 16
    b.Text = text
    local c = Instance.new("UICorner", b)
    local active = false
    b.MouseButton1Click:Connect(function()
        active = not active
        b.BackgroundColor3 = active and Color3.fromRGB(100, 0, 200) or Color3.fromRGB(40, 40, 50)
        callback(active)
        status.Text = active and ("üü¢ Running: "..text) or "üî¥ Idle"
        status.TextColor3 = active and Color3.fromRGB(100,255,100) or Color3.fromRGB(255,100,100)
    end)
end

createButton("Auto Farm", function(state)
    getgenv().AutoFarm = state
    if state then autoFarmLoop() else getgenv().IsRunning = false end
end)

createButton("Auto Deliver", function(state)
    getgenv().AutoDeliver = state
    if state then autoDeliverLoop() else getgenv().IsRunning = false end
end)

local speedBox = Instance.new("TextBox", content)
speedBox.Size = UDim2.new(1, -20, 0, 35)
speedBox.PlaceholderText = "Enter Speed"
speedBox.Text = tostring(getgenv().Speed)
speedBox.TextColor3 = Color3.new(1,1,1)
speedBox.BackgroundColor3 = Color3.fromRGB(35,35,45)
speedBox.Font = Enum.Font.Gotham
speedBox.TextSize = 16
local sc = Instance.new("UICorner", speedBox)

speedBox.FocusLost:Connect(function()
    local val = tonumber(speedBox.Text)
    if val then getgenv().Speed = val end
end)

-- Dragging
do
    local dragging, start, startPos
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            start = input.Position
            startPos = frame.Position
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseMovement) then
            local delta = input.Position - start
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
end

-- Minimize + Close
minBtn.MouseButton1Click:Connect(function()
    getgenv().Minimized = not getgenv().Minimized
    if getgenv().Minimized then
        TweenService:Create(frame, TweenInfo.new(0.3), {Size = UDim2.new(0, 80, 0, 80)}):Play()
        for _, ch in pairs(frame:GetChildren()) do if ch ~= minBtn and ch ~= closeBtn then ch.Visible = false end end
        minBtn.Text = "+"
    else
        TweenService:Create(frame, TweenInfo.new(0.3), {Size = UDim2.new(0, 300, 0, 250)}):Play()
        for _, ch in pairs(frame:GetChildren()) do if ch ~= minBtn and ch ~= closeBtn then ch.Visible = true end end
        minBtn.Text = "‚Äì"
    end
end)

local dockIcon = Instance.new("ImageButton", gui)
dockIcon.Size = UDim2.new(0, 50, 0, 50)
dockIcon.Position = UDim2.new(1, -60, 1, -60)
dockIcon.Image = "rbxassetid://7072724538"
dockIcon.BackgroundTransparency = 1
dockIcon.Visible = false

closeBtn.MouseButton1Click:Connect(function()
    getgenv().Closed = true
    frame.Visible = false
    dockIcon.Visible = true
end)

dockIcon.MouseButton1Click:Connect(function()
    frame.Visible = true
    dockIcon.Visible = false
end)

warn("‚úÖ Zuan WM Dock Final Fix Total (Flat Dark Panel) Loaded Successfully!")
